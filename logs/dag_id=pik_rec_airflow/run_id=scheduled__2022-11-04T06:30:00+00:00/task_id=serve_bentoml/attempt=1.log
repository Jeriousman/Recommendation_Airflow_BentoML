[2022-11-04T07:17:01.940+0000] {taskinstance.py:1165} INFO - Dependencies all met for <TaskInstance: pik_rec_airflow.serve_bentoml scheduled__2022-11-04T06:30:00+00:00 [queued]>
[2022-11-04T07:17:01.956+0000] {taskinstance.py:1165} INFO - Dependencies all met for <TaskInstance: pik_rec_airflow.serve_bentoml scheduled__2022-11-04T06:30:00+00:00 [queued]>
[2022-11-04T07:17:01.956+0000] {taskinstance.py:1362} INFO - 
--------------------------------------------------------------------------------
[2022-11-04T07:17:01.956+0000] {taskinstance.py:1363} INFO - Starting attempt 1 of 1
[2022-11-04T07:17:01.956+0000] {taskinstance.py:1364} INFO - 
--------------------------------------------------------------------------------
[2022-11-04T07:17:01.975+0000] {taskinstance.py:1383} INFO - Executing <Task(BashOperator): serve_bentoml> on 2022-11-04 06:30:00+00:00
[2022-11-04T07:17:01.982+0000] {standard_task_runner.py:54} INFO - Started process 404 to run task
[2022-11-04T07:17:01.986+0000] {standard_task_runner.py:82} INFO - Running: ['***', 'tasks', 'run', 'pik_rec_***', 'serve_bentoml', 'scheduled__2022-11-04T06:30:00+00:00', '--job-id', '11', '--raw', '--subdir', 'DAGS_FOLDER/pik_rec_***.py', '--cfg-path', '/tmp/tmp3cqly9t9']
[2022-11-04T07:17:01.987+0000] {standard_task_runner.py:83} INFO - Job 11: Subtask serve_bentoml
[2022-11-04T07:17:01.988+0000] {dagbag.py:525} INFO - Filling up the DagBag from /opt/***/dags/pik_rec_***.py
[2022-11-04T07:17:05.035+0000] {warnings.py:109} WARNING - /home/***/.local/lib/python3.8/site-packages/***/configuration.py:545: DeprecationWarning: The sql_alchemy_conn option in [core] has been moved to the sql_alchemy_conn option in [database] - the old setting has been used, but please update your config.
  option = self._get_environment_variables(deprecated_key, deprecated_section, key, section)

[2022-11-04T07:17:05.090+0000] {task_command.py:384} INFO - Running <TaskInstance: pik_rec_airflow.serve_bentoml scheduled__2022-11-04T06:30:00+00:00 [running]> on host 330ee51a880d
[2022-11-04T07:17:05.174+0000] {taskinstance.py:1590} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_EMAIL=hojun.seo@pikurate.com
AIRFLOW_CTX_DAG_OWNER=***
AIRFLOW_CTX_DAG_ID=pik_rec_***
AIRFLOW_CTX_TASK_ID=serve_bentoml
AIRFLOW_CTX_EXECUTION_DATE=2022-11-04T06:30:00+00:00
AIRFLOW_CTX_TRY_NUMBER=1
AIRFLOW_CTX_DAG_RUN_ID=scheduled__2022-11-04T06:30:00+00:00
[2022-11-04T07:17:05.175+0000] {subprocess.py:63} INFO - Tmp dir root location: 
 /tmp
[2022-11-04T07:17:05.175+0000] {subprocess.py:75} INFO - Running command: ['/bin/bash', '-c', ' \n            \n            \n            fuser -k 3001/tcp; bentoml serve -p 3001 pik_recommender_bento:latest --production\n        ']
[2022-11-04T07:17:05.207+0000] {subprocess.py:86} INFO - Output:
[2022-11-04T07:17:15.078+0000] {subprocess.py:93} INFO - 2022-11-04T07:17:14+0000 [INFO] [cli] Environ for worker 0: set CUDA_VISIBLE_DEVICES to 0
[2022-11-04T07:17:15.091+0000] {subprocess.py:93} INFO - 2022-11-04T07:17:15+0000 [INFO] [cli] Prometheus metrics for HTTP BentoServer from "pik_recommender_bento:latest" can be accessed at http://localhost:3001/metrics.
[2022-11-04T07:17:16.881+0000] {subprocess.py:93} INFO - 2022-11-04T07:17:16+0000 [INFO] [cli] Starting production HTTP BentoServer from "pik_recommender_bento:latest" listening on http://0.0.0.0:3001 (Press CTRL+C to quit)
[2022-11-04T07:17:37.664+0000] {subprocess.py:93} INFO - 2022-11-04T07:17:37+0000 [WARNING] [runner:pik_recommender_model:1] No versions of Flax or Jax found on the current machine. In order to use Flax with transformers 4.x and above, refer to https://github.com/google/flax#quick-install
[2022-11-04T07:17:37.712+0000] {subprocess.py:93} INFO - 2022-11-04T07:17:37+0000 [INFO] [runner:pik_recommender_model:1] Loading 'feature-extraction' pipeline 'pik_recommender_model:ufjbjhc4cchmiasc' with kwargs {'device': 0}.
[2022-11-04T07:22:12.892+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:12+0000 [INFO] [api_server:pik_recommender_bento:14] 172.18.0.1:38804 (scheme=http,method=GET,path=/,type=,length=) (status=200,type=text/html; charset=utf-8,length=2859) 1.445ms (trace=6180bb71a4707c553ecf6098be42478f,span=a70be3c00be46e4b,sampled=0)
[2022-11-04T07:22:12.963+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:12+0000 [INFO] [api_server:pik_recommender_bento:14] 172.18.0.1:38804 (scheme=http,method=GET,path=/static_content/swagger-ui.css,type=,length=) (status=200,type=text/css; charset=utf-8,length=143980) 53.827ms (trace=6dc63107f99120faa93663233d9b3b2b,span=69153d3ebee7eb53,sampled=0)
[2022-11-04T07:22:12.995+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:12+0000 [INFO] [api_server:pik_recommender_bento:17] 172.18.0.1:38806 (scheme=http,method=GET,path=/static_content/index.css,type=,length=) (status=200,type=text/css; charset=utf-8,length=1125) 73.093ms (trace=2908fe857b2d657e35e963af819457a0,span=c1efcc028e92368e,sampled=0)
[2022-11-04T07:22:13.000+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:13+0000 [INFO] [api_server:pik_recommender_bento:19] 172.18.0.1:38824 (scheme=http,method=GET,path=/static_content/swagger-initializer.js,type=,length=) (status=200,type=application/javascript,length=381) 54.925ms (trace=e9b419fedb57d3bd73fefce97412b76c,span=2e2e5a667a0c546c,sampled=0)
[2022-11-04T07:22:13.001+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:13+0000 [INFO] [api_server:pik_recommender_bento:10] 172.18.0.1:38832 (scheme=http,method=GET,path=/static_content/swagger-ui-standalone-preset.js,type=,length=) (status=200,type=application/javascript,length=339540) 55.087ms (trace=2092801515fcb8e6098d1b4ebbf8857c,span=9e4ea82c57068dd3,sampled=0)
[2022-11-04T07:22:13.025+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:13+0000 [INFO] [api_server:pik_recommender_bento:9] 172.18.0.1:38818 (scheme=http,method=GET,path=/static_content/swagger-ui-bundle.js,type=,length=) (status=200,type=application/javascript,length=1096221) 80.949ms (trace=191278c287a0d5cd88d80ce175154f93,span=61427360791bda1e,sampled=0)
[2022-11-04T07:22:13.441+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:13+0000 [INFO] [api_server:pik_recommender_bento:10] 172.18.0.1:38832 (scheme=http,method=GET,path=/static_content/favicon-32x32.png,type=,length=) (status=200,type=image/png,length=1912) 6.452ms (trace=67453d2e21e548856916427e67979c9a,span=4ce8e285430ceb4f,sampled=0)
[2022-11-04T07:22:13.450+0000] {subprocess.py:93} INFO - 2022-11-04T07:22:13+0000 [INFO] [api_server:pik_recommender_bento:9] 172.18.0.1:38818 (scheme=http,method=GET,path=/docs.json,type=,length=) (status=200,type=application/json,length=4716) 35.215ms (trace=0046c94759e11edef69532beb4163b48,span=adb5feb80e7a0dda,sampled=0)
[2022-11-04T07:26:55.659+0000] {subprocess.py:93} INFO - 2022-11-04T07:26:55+0000 [ERROR] [api_server:pik_recommender_bento:15] Exception on /predict [POST] (trace=b31ee03dce0e4c0bd432a2268e468808,span=f006af57679a01f4,sampled=0)
[2022-11-04T07:26:55.660+0000] {subprocess.py:93} INFO - Traceback (most recent call last):
[2022-11-04T07:26:55.661+0000] {subprocess.py:93} INFO -   File "/home/***/.local/lib/python3.8/site-packages/bentoml/_internal/server/http_app.py", line 330, in api_func
[2022-11-04T07:26:55.662+0000] {subprocess.py:93} INFO -     output: t.Any = await run_in_threadpool(api.func, **input_data)
[2022-11-04T07:26:55.662+0000] {subprocess.py:93} INFO -   File "/home/***/.local/lib/python3.8/site-packages/starlette/concurrency.py", line 41, in run_in_threadpool
[2022-11-04T07:26:55.662+0000] {subprocess.py:93} INFO -     return await anyio.to_thread.run_sync(func, *args)
[2022-11-04T07:26:55.663+0000] {subprocess.py:93} INFO -   File "/home/***/.local/lib/python3.8/site-packages/anyio/to_thread.py", line 31, in run_sync
[2022-11-04T07:26:55.663+0000] {subprocess.py:93} INFO -     return await get_asynclib().run_sync_in_worker_thread(
[2022-11-04T07:26:55.663+0000] {subprocess.py:93} INFO -   File "/home/***/.local/lib/python3.8/site-packages/anyio/_backends/_asyncio.py", line 937, in run_sync_in_worker_thread
[2022-11-04T07:26:55.664+0000] {subprocess.py:93} INFO -     return await future
[2022-11-04T07:26:55.665+0000] {subprocess.py:93} INFO -   File "/home/***/.local/lib/python3.8/site-packages/anyio/_backends/_asyncio.py", line 867, in run
[2022-11-04T07:26:55.665+0000] {subprocess.py:93} INFO -     result = context.run(func, *args)
[2022-11-04T07:26:55.666+0000] {subprocess.py:93} INFO -   File "/root/bentoml/bentos/pik_recommender_bento/vneqzws4cclymasc/src/bento_service_pik_rec.py", line 801, in predict
[2022-11-04T07:26:55.667+0000] {subprocess.py:93} INFO -     similarity_list = rec_pik_by_lang(pik_id, user_id, user_lang_dict, user_pik, piks_vec, piktitle_vec, num_link_by_pik,  topk=10, threshold=0.82, second_threshold=0.75, piktitle_threshold=0.77, num_link_threshold=3)
[2022-11-04T07:26:55.667+0000] {subprocess.py:93} INFO -   File "/root/bentoml/bentos/pik_recommender_bento/vneqzws4cclymasc/src/bento_service_pik_rec.py", line 780, in rec_pik_by_lang
[2022-11-04T07:26:55.668+0000] {subprocess.py:93} INFO -     if user_lang_dict[user_id] == 'ko':
[2022-11-04T07:26:55.669+0000] {subprocess.py:93} INFO - KeyError: '53'
[2022-11-04T07:26:55.670+0000] {subprocess.py:93} INFO - 2022-11-04T07:26:55+0000 [INFO] [api_server:pik_recommender_bento:15] 172.18.0.1:45784 (scheme=http,method=POST,path=/predict,type=multipart/form-data; boundary=----WebKitFormBoundaryCFq3BjLmTmhxIumZ,length=235) (status=500,type=application/json,length=110) 39.362ms (trace=b31ee03dce0e4c0bd432a2268e468808,span=f006af57679a01f4,sampled=0)
[2022-11-04T07:27:03.841+0000] {subprocess.py:93} INFO - 2022-11-04T07:27:03+0000 [INFO] [api_server:pik_recommender_bento:9] 172.18.0.1:45790 (scheme=http,method=POST,path=/predict,type=multipart/form-data; boundary=----WebKitFormBoundaryWmYc2WNGOeROcqoi,length=235) (status=200,type=application/json,length=169) 536.595ms (trace=a867941988cd293df3d019f24bc30473,span=6fea7ae12a3f1729,sampled=0)
[2022-11-04T07:27:23.303+0000] {local_task_job.py:87} ERROR - Received SIGTERM. Terminating subprocesses
[2022-11-04T07:27:23.315+0000] {process_utils.py:129} INFO - Sending Signals.SIGTERM to group 404. PIDs of all processes in the group: [425, 427, 471, 472, 473, 474, 475, 476, 479, 481, 482, 485, 487, 489, 491, 492, 494, 497, 499, 500, 503, 505, 508, 404]
[2022-11-04T07:27:23.316+0000] {process_utils.py:84} INFO - Sending the signal Signals.SIGTERM to group 404
[2022-11-04T07:27:23.317+0000] {taskinstance.py:1562} ERROR - Received SIGTERM. Terminating subprocesses.
[2022-11-04T07:27:23.317+0000] {subprocess.py:104} INFO - Sending SIGTERM signal to process group
[2022-11-04T07:27:23.353+0000] {taskinstance.py:1851} ERROR - Task failed with exception
Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/operators/bash.py", line 187, in execute
    result = self.subprocess_hook.run_command(
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/hooks/subprocess.py", line 91, in run_command
    for raw_line in iter(self.sub_process.stdout.readline, b''):
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/models/taskinstance.py", line 1564, in signal_handler
    raise AirflowException("Task received SIGTERM signal")
airflow.exceptions.AirflowException: Task received SIGTERM signal
[2022-11-04T07:27:23.373+0000] {taskinstance.py:1401} INFO - Marking task as FAILED. dag_id=pik_rec_***, task_id=serve_bentoml, execution_date=20221104T063000, start_date=20221104T071701, end_date=20221104T072723
[2022-11-04T07:27:24.232+0000] {standard_task_runner.py:102} ERROR - Failed to execute job 11 for task serve_bentoml (Task received SIGTERM signal; 404)
[2022-11-04T07:27:24.765+0000] {process_utils.py:79} INFO - Process psutil.Process(pid=404, status='terminated', exitcode=1, started='07:17:01') (404) terminated with exit code 1
[2022-11-04T07:27:25.690+0000] {process_utils.py:79} INFO - Process psutil.Process(pid=425, status='terminated', started='07:17:04') (425) terminated with exit code None
